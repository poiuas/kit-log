<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a1628">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Kit Log">
<title>Kit Log</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@300;400;500&display=swap');

  :root {
    --navy: #0a1628;
    --deep: #0d1f3c;
    --mid: #1a3358;
    --accent: #00b4d8;
    --accent2: #0077b6;
    --gold: #f4a261;
    --light: #caf0f8;
    --text: #e8f4f8;
    --muted: #7fa8c0;
    --surface: rgba(255,255,255,0.05);
    --border: rgba(0,180,216,0.2);
    --green: #2a9d8f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--navy);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    background-image:
      radial-gradient(ellipse at 20% 0%, rgba(0,119,182,0.3) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(0,180,216,0.15) 0%, transparent 50%);
  }

  header {
    background: rgba(10,22,40,0.95);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.6rem;
    letter-spacing: 0.05em;
    color: var(--accent);
    text-transform: uppercase;
  }
  .logo span { color: var(--gold); }

  nav {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
  }

  nav button {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 6px 14px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
  }
  nav button.active { background: var(--accent); color: var(--navy); }

  .setup-banner {
    background: linear-gradient(135deg, rgba(42,157,143,0.12), rgba(0,180,216,0.08));
    border-bottom: 1px solid rgba(42,157,143,0.35);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .setup-banner.connected {
    background: linear-gradient(135deg, rgba(42,157,143,0.18), rgba(42,157,143,0.08));
    border-bottom-color: rgba(42,157,143,0.45);
  }
  .setup-banner-text {
    flex: 1;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.88rem;
    color: #caf0f8;
    line-height: 1.4;
  }
  .setup-banner-text span { color: #4ecdc4; font-weight: 700; }
  .setup-btn {
    background: rgba(42,157,143,0.25);
    border: 1px solid rgba(42,157,143,0.55);
    color: #caf0f8;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 7px 14px;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
  }
  .setup-btn:hover { background: rgba(42,157,143,0.45); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(5,12,25,0.92);
    z-index: 200;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
  }
  .modal-overlay.open { display: flex; align-items: flex-start; justify-content: center; padding-top: 30px; }
  .modal {
    background: #0d1f3c;
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    max-width: 560px;
    width: 100%;
  }
  .modal h2 {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.5rem;
    letter-spacing: 0.04em;
    color: var(--accent);
    margin-bottom: 6px;
  }
  .modal .subtitle { color: var(--muted); font-size: 0.87rem; margin-bottom: 24px; line-height: 1.5; }

  .step { display: flex; gap: 14px; margin-bottom: 22px; align-items: flex-start; }
  .step-num {
    background: var(--accent2);
    color: white;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 0.9rem;
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .step-content { flex: 1; }
  .step-content strong { display: block; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 1rem; color: var(--text); margin-bottom: 5px; }
  .step-content p { font-size: 0.84rem; color: var(--muted); line-height: 1.55; }
  .step-content a { color: var(--accent); text-decoration: none; }
  .step-content a:hover { text-decoration: underline; }

  .code-block {
    background: rgba(0,0,0,0.45);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    margin-top: 10px;
    font-family: 'Courier New', monospace;
    font-size: 0.72rem;
    color: #90e0ef;
    white-space: pre;
    overflow-x: auto;
    line-height: 1.65;
  }
  .copy-btn {
    margin-top: 8px;
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.78rem;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }

  .url-input-row { display: flex; gap: 8px; margin-top: 12px; }
  .url-input-row input {
    flex: 1;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 0.88rem;
    padding: 10px 14px;
    outline: none;
  }
  .url-input-row input:focus { border-color: var(--accent); }
  .url-input-row input::placeholder { color: var(--muted); font-size: 0.78rem; }
  .save-url-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: var(--navy);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 800;
    font-size: 0.9rem;
    padding: 10px 18px;
    cursor: pointer;
    letter-spacing: 0.04em;
    white-space: nowrap;
  }
  .modal-close {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 20px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .modal-close:hover { border-color: var(--accent); color: var(--accent); }

  /* VIEWS */
  .view { display: none; padding: 20px; max-width: 680px; margin: 0 auto; }
  .view.active { display: block; }

  .form-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .section-title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .field { margin-bottom: 16px; }
  .field:last-child { margin-bottom: 0; }

  label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--muted);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  input[type="date"], input[type="text"], input[type="number"], select {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 1rem;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
  }
  input:focus, select:focus { border-color: var(--accent); }

  textarea {
    width: 100%;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 1rem;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
    resize: vertical;
  }
  textarea:focus { border-color: var(--accent); }

  .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
  .chip-group label { margin: 0; text-transform: none; letter-spacing: 0; font-size: 0.9rem; }
  .chip input { display: none; }
  .chip span {
    display: inline-block;
    padding: 7px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.2);
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--muted);
    transition: all 0.15s;
    user-select: none;
  }
  .chip input:checked + span { background: var(--accent); border-color: var(--accent); color: var(--navy); font-weight: 600; }

  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .submit-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    border: none;
    border-radius: 10px;
    color: var(--navy);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 1.1rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 16px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
    margin-top: 8px;
  }
  .submit-btn:active { transform: scale(0.98); opacity: 0.9; }
  .submit-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

  .sync-indicator {
    display: flex; align-items: center; gap: 8px;
    justify-content: center;
    margin-top: 10px;
    font-size: 0.82rem;
    color: var(--muted);
    min-height: 22px;
    transition: color 0.3s;
  }
  .sync-indicator.syncing { color: var(--accent); }
  .sync-indicator.synced { color: var(--green); }
  .sync-indicator.error { color: #e76f51; }
  .dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }
  .pulse { animation: pulse 1s infinite; }

  .success-toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--accent);
    color: var(--navy);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    padding: 12px 28px;
    border-radius: 30px;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 999;
    letter-spacing: 0.05em;
    pointer-events: none;
  }
  .success-toast.show { transform: translateX(-50%) translateY(0); }

  .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  th {
    background: var(--mid);
    color: var(--accent);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 10px 12px;
    text-align: left;
    white-space: nowrap;
  }
  td { padding: 9px 12px; border-top: 1px solid var(--border); color: var(--text); white-space: nowrap; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
  tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
  tr:hover td { background: rgba(0,180,216,0.07); }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
  .empty-state p { font-size: 0.9rem; line-height: 1.6; }

  .toolbar { display: flex; justify-content: flex-end; margin-bottom: 12px; }
  .export-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .export-btn:hover { border-color: var(--accent); color: var(--accent); }

  .delete-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; padding: 4px; transition: color 0.2s; }
  .delete-btn:hover { color: #e63946; }

  .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
  .stat-box { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px; text-align: center; }
  .stat-box .val { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 1.8rem; color: var(--accent); }
  .stat-box .lbl { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px; }

  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
  .chart-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 0.75rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); margin-bottom: 16px; }
</style>
</head>
<body>

<header>
  <div class="logo">Kit <span>Log</span></div>
  <nav>
    <button class="active" onclick="showView('form',this)">Log</button>
    <button onclick="showView('table',this)">Table</button>
    <button onclick="showView('charts',this)">Charts</button>
  </nav>
</header>

<div class="setup-banner" id="setup-banner">
  <div class="setup-banner-text" id="banner-text">ðŸ“Š Connect to Google Sheets to sync across all your devices</div>
  <button class="setup-btn" id="banner-btn" onclick="openModal()">Set Up</button>
</div>

<!-- SETUP MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>Connect Google Sheets</h2>
    <p class="subtitle">Takes about 3 minutes. Every session you log will automatically appear as a new row in your Google Sheet â€” accessible from your phone, laptop, anywhere.</p>

    <div class="step">
      <div class="step-num">1</div>
      <div class="step-content">
        <strong>Create a new Google Sheet</strong>
        <p>Go to <a href="https://sheets.new" target="_blank">sheets.new</a> and create a blank spreadsheet. Name it "Kit Log".</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">2</div>
      <div class="step-content">
        <strong>Open the Apps Script editor</strong>
        <p>In your sheet click <b>Extensions â†’ Apps Script</b>. Delete any existing code and paste this script:</p>
        <div class="code-block" id="script-code">const SHEET_NAME = "Sessions";

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow([
      "Date","Venue","Hours","Wind","Sea","Focus",
      "Main","Jib","Kite","Boat","Board","Mast",
      "Shrouds","Luff Wire","Jib Wire","Comments","Logged At"
    ]);
  }
  const d = JSON.parse(e.postData.contents);
  sheet.appendRow([
    d.date, d.venue, d.hours, d.wind, d.sea,
    d.focus, d.main, d.jib, d.kite, d.boat,
    d.board, d.mast, d.shrouds, d.luffwire,
    d.jibwire, d.comments, new Date().toISOString()
  ]);
  return ContentService
    .createTextOutput(JSON.stringify({result:"success"}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet() {
  return ContentService
    .createTextOutput(JSON.stringify({status:"ok"}))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
        <button class="copy-btn" onclick="copyScript()">ðŸ“‹ Copy Script</button>
      </div>
    </div>

    <div class="step">
      <div class="step-num">3</div>
      <div class="step-content">
        <strong>Deploy as a Web App</strong>
        <p>Click <b>Deploy â†’ New deployment</b>. Set type to <b>Web app</b>. Set "Execute as" â†’ <b>Me</b> and "Who has access" â†’ <b>Anyone</b>. Click Deploy and approve the permissions when prompted.</p>
      </div>
    </div>

    <div class="step">
      <div class="step-num">4</div>
      <div class="step-content">
        <strong>Paste your Web App URL here</strong>
        <p>Copy the Web App URL shown after deployment and paste it below:</p>
        <div class="url-input-row">
          <input type="text" id="sheets-url-input" placeholder="https://script.google.com/macros/s/...">
          <button class="save-url-btn" onclick="saveSheetUrl()">Save</button>
        </div>
      </div>
    </div>

    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- LOG FORM -->
<div id="view-form" class="view active">
  <form id="kitForm">

    <div class="form-section">
      <div class="section-title">Session Info</div>
      <div class="two-col">
        <div class="field">
          <label>Date</label>
          <input type="date" id="f-date" required>
        </div>
        <div class="field">
          <label>Total Hours</label>
          <input type="number" id="f-hours" min="0" max="24" step="0.5" placeholder="e.g. 3.5">
        </div>
      </div>
      <div class="field">
        <label>Venue</label>
        <input type="text" id="f-venue" placeholder="e.g. Cowes, Solent">
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Conditions</div>
      <div class="field">
        <label>Wind Speed</label>
        <div class="chip-group">
          <label class="chip"><input type="radio" name="wind" value="0-6kts"><span>0â€“6 kts</span></label>
          <label class="chip"><input type="radio" name="wind" value="7-10kts"><span>7â€“10 kts</span></label>
          <label class="chip"><input type="radio" name="wind" value="11-15kts"><span>11â€“15 kts</span></label>
          <label class="chip"><input type="radio" name="wind" value="16-20kts"><span>16â€“20 kts</span></label>
          <label class="chip"><input type="radio" name="wind" value="20-25kts"><span>20â€“25 kts</span></label>
          <label class="chip"><input type="radio" name="wind" value="25+kts"><span>25+ kts</span></label>
        </div>
      </div>
      <div class="field">
        <label>Sea State</label>
        <div class="chip-group">
          <label class="chip"><input type="radio" name="sea" value="Flat"><span>Flat</span></label>
          <label class="chip"><input type="radio" name="sea" value="Chop"><span>Chop</span></label>
          <label class="chip"><input type="radio" name="sea" value="Swell"><span>Swell</span></label>
        </div>
      </div>
      <div class="field">
        <label>Focus</label>
        <div class="chip-group">
          <label class="chip"><input type="radio" name="focus" value="Speed"><span>Speed</span></label>
          <label class="chip"><input type="radio" name="focus" value="Handling"><span>Handling</span></label>
          <label class="chip"><input type="radio" name="focus" value="Starting"><span>Starting</span></label>
          <label class="chip"><input type="radio" name="focus" value="Racing"><span>Racing</span></label>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Sails</div>
      <div class="field">
        <label>Main</label>
        <select id="f-main">
          <option value="">â€” Select â€”</option>
          <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option><option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option>
        </select>
      </div>
      <div class="field">
        <label>Jib</label>
        <select id="f-jib">
          <option value="">â€” Select â€”</option>
          <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option><option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option>
        </select>
      </div>
      <div class="field">
        <label>Kite</label>
        <select id="f-kite">
          <option value="">â€” Select â€”</option>
          <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option><option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option>
        </select>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Equipment</div>
      <div class="two-col">
        <div class="field">
          <label>Boat</label>
          <input type="text" id="f-boat" placeholder="The Dame">
        </div>
        <div class="field">
          <label>Board</label>
          <select id="f-board">
            <option value="">â€” Select â€”</option>
            <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option><option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Rigging</div>
      <div class="two-col">
        <div class="field">
          <label>Mast</label>
          <select id="f-mast">
            <option value="">â€” Select â€”</option>
            <option>HD1</option><option>HD2</option><option>HD3</option><option>HD4</option><option>HD5</option><option>HD6</option><option>HD7</option><option>HD8</option><option>HD9</option><option>HD10</option><option>HD11</option><option>HD12</option><option>HD13</option><option>HD14</option><option>HD15</option>
          </select>
        </div>
        <div class="field">
          <label>Shrouds</label>
          <select id="f-shrouds">
            <option value="">â€” Select â€”</option>
            <option>HD1</option><option>HD2</option><option>HD3</option><option>HD4</option><option>HD5</option><option>HD6</option><option>HD7</option><option>HD8</option><option>HD9</option><option>HD10</option><option>HD11</option><option>HD12</option><option>HD13</option><option>HD14</option><option>HD15</option>
          </select>
        </div>
        <div class="field">
          <label>Luff Wire</label>
          <select id="f-luffwire">
            <option value="">â€” Select â€”</option>
            <option>HD1</option><option>HD2</option><option>HD3</option><option>HD4</option><option>HD5</option><option>HD6</option><option>HD7</option><option>HD8</option><option>HD9</option><option>HD10</option><option>HD11</option><option>HD12</option><option>HD13</option><option>HD14</option><option>HD15</option>
          </select>
        </div>
        <div class="field">
          <label>Jib Wire</label>
          <select id="f-jibwire">
            <option value="">â€” Select â€”</option>
            <option>HD1</option><option>HD2</option><option>HD3</option><option>HD4</option><option>HD5</option><option>HD6</option><option>HD7</option><option>HD8</option><option>HD9</option><option>HD10</option><option>HD11</option><option>HD12</option><option>HD13</option><option>HD14</option><option>HD15</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">Notes</div>
      <div class="field">
        <label>Comments</label>
        <textarea id="f-comments" rows="4" placeholder="Session notes, observations, tuning changes..."></textarea>
      </div>
    </div>

    <button type="submit" class="submit-btn" id="submit-btn">âš“ Log Session</button>
    <div class="sync-indicator" id="sync-status"></div>
  </form>
</div>

<!-- TABLE -->
<div id="view-table" class="view">
  <div class="toolbar">
    <button class="export-btn" onclick="exportCSV()">Export CSV</button>
  </div>
  <div id="table-container"></div>
</div>

<!-- CHARTS -->
<div id="view-charts" class="view">
  <div id="stats-row" class="stats-row"></div>
  <div class="chart-card"><div class="chart-title">Hours on the Water</div><canvas id="chartHours" height="200"></canvas></div>
  <div class="chart-card"><div class="chart-title">Wind Conditions</div><canvas id="chartWind" height="220"></canvas></div>
  <div class="chart-card"><div class="chart-title">Session Focus</div><canvas id="chartFocus" height="220"></canvas></div>
  <div class="chart-card"><div class="chart-title">Sail Usage â€” Mains</div><canvas id="chartMains" height="200"></canvas></div>
  <div class="chart-card"><div class="chart-title">Sail Usage â€” Jibs</div><canvas id="chartJibs" height="200"></canvas></div>
  <div class="chart-card"><div class="chart-title">Sail Usage â€” Kites</div><canvas id="chartKites" height="200"></canvas></div>
  <div class="chart-card"><div class="chart-title">Rigging Usage</div><canvas id="chartRigging" height="300"></canvas></div>
  <div class="chart-card"><div class="chart-title">Board Usage</div><canvas id="chartBoard" height="200"></canvas></div>
</div>

<div class="success-toast" id="toast">âœ“ Session Logged!</div>

<script>
const STORE_KEY = 'sailing_kit_log_v1';
const SHEETS_KEY = 'sailing_sheets_url';
let entries = [];
let sheetsUrl = '';

async function load() {
  try { const r = await window.storage.get(STORE_KEY); if (r?.value) entries = JSON.parse(r.value); } catch(e) { entries = []; }
  try { const r = await window.storage.get(SHEETS_KEY); if (r?.value) sheetsUrl = r.value; } catch(e) {}
}
async function save() {
  try { await window.storage.set(STORE_KEY, JSON.stringify(entries)); } catch(e) {}
}

function updateBanner() {
  const banner = document.getElementById('setup-banner');
  const text = document.getElementById('banner-text');
  const btn = document.getElementById('banner-btn');
  if (sheetsUrl) {
    banner.classList.add('connected');
    text.innerHTML = 'âœ… <span>Syncing to Google Sheets</span> â€” every session saves automatically';
    btn.textContent = 'Change';
  } else {
    banner.classList.remove('connected');
    text.innerHTML = 'ðŸ“Š Connect to Google Sheets to sync across all your devices';
    btn.textContent = 'Set Up';
  }
}

function openModal() {
  document.getElementById('modal').classList.add('open');
  if (sheetsUrl) document.getElementById('sheets-url-input').value = sheetsUrl;
}
function closeModal() { document.getElementById('modal').classList.remove('open'); }
document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

function copyScript() {
  navigator.clipboard.writeText(document.getElementById('script-code').textContent).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = 'âœ“ Copied!';
    setTimeout(() => btn.textContent = orig, 2000);
  });
}

async function saveSheetUrl() {
  const val = document.getElementById('sheets-url-input').value.trim();
  if (!val || !val.includes('script.google.com')) { alert('Please paste a valid Google Apps Script Web App URL'); return; }
  sheetsUrl = val;
  try { await window.storage.set(SHEETS_KEY, sheetsUrl); } catch(e) {}
  updateBanner();
  closeModal();
  setSyncStatus('synced', 'âœ… Connected to Google Sheets');
  setTimeout(() => setSyncStatus('', ''), 3000);
}

function showView(v, btn) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  if (btn) btn.classList.add('active');
  if (v === 'table') renderTable();
  if (v === 'charts') renderCharts();
}

function setSyncStatus(type, msg) {
  const el = document.getElementById('sync-status');
  el.className = 'sync-indicator' + (type ? ' ' + type : '');
  el.innerHTML = msg ? `<div class="dot${type==='syncing'?' pulse':''}"></div>${msg}` : '';
}

document.getElementById('kitForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const r = n => { const el = document.querySelector(`input[name="${n}"]:checked`); return el ? el.value : ''; };
  const entry = {
    id: Date.now(),
    date: document.getElementById('f-date').value,
    venue: document.getElementById('f-venue').value,
    hours: document.getElementById('f-hours').value,
    wind: r('wind'), sea: r('sea'), focus: r('focus'),
    main: document.getElementById('f-main').value,
    jib: document.getElementById('f-jib').value,
    kite: document.getElementById('f-kite').value,
    boat: document.getElementById('f-boat').value,
    board: document.getElementById('f-board').value,
    mast: document.getElementById('f-mast').value,
    shrouds: document.getElementById('f-shrouds').value,
    luffwire: document.getElementById('f-luffwire').value,
    jibwire: document.getElementById('f-jibwire').value,
    comments: document.getElementById('f-comments').value,
  };
  entries.unshift(entry);
  await save();
  showToast();
  e.target.reset();
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('f-boat').value = 'The Dame';

  if (sheetsUrl) {
    setSyncStatus('syncing', 'Syncing to Google Sheetsâ€¦');
    document.getElementById('submit-btn').disabled = true;
    try {
      await fetch(sheetsUrl, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(entry) });
      setSyncStatus('synced', 'âœ… Saved to Google Sheets');
    } catch(err) {
      setSyncStatus('error', 'âš ï¸ Saved locally â€” Sheets sync failed');
    }
    document.getElementById('submit-btn').disabled = false;
    setTimeout(() => setSyncStatus('',''), 4000);
  }
});

function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function renderTable() {
  const container = document.getElementById('table-container');
  if (!entries.length) {
    container.innerHTML = `<div class="empty-state"><div class="icon">â›µ</div><p>No sessions logged yet.<br>Fill in the Log tab to get started.</p></div>`;
    return;
  }
  const cols = ['Date','Venue','Hrs','Wind','Sea','Focus','Main','Jib','Kite','Boat','Board','Mast','Shrouds','Luff Wire','Jib Wire','Comments',''];
  const fields = ['date','venue','hours','wind','sea','focus','main','jib','kite','boat','board','mast','shrouds','luffwire','jibwire','comments'];
  let html = `<div class="table-wrap"><table><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>`;
  entries.forEach(en => {
    html += `<tr>${fields.map(f=>`<td title="${en[f]||''}">${en[f]||'â€”'}</td>`).join('')}<td><button class="delete-btn" onclick="deleteEntry(${en.id})">âœ•</button></td></tr>`;
  });
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

async function deleteEntry(id) {
  if (!confirm('Delete this session?')) return;
  entries = entries.filter(e => e.id !== id);
  await save();
  renderTable();
}

function exportCSV() {
  if (!entries.length) return;
  const headers = ['Date','Venue','Hours','Wind','Sea','Focus','Main','Jib','Kite','Boat','Board','Mast','Shrouds','Luff Wire','Jib Wire','Comments'];
  const fields = ['date','venue','hours','wind','sea','focus','main','jib','kite','boat','board','mast','shrouds','luffwire','jibwire','comments'];
  const rows = entries.map(e => fields.map(f => `"${(e[f]||'').toString().replace(/"/g,'""')}"`).join(','));
  const a = document.createElement('a');
  a.href = 'data:text/csv,' + encodeURIComponent([headers.join(','), ...rows].join('\n'));
  a.download = 'kit-log.csv';
  a.click();
}

let charts = {};
function renderCharts() {
  const totalHours = entries.reduce((s, e) => s + parseFloat(e.hours||0), 0);
  document.getElementById('stats-row').innerHTML = `
    <div class="stat-box"><div class="val">${entries.length}</div><div class="lbl">Sessions</div></div>
    <div class="stat-box"><div class="val">${totalHours.toFixed(1)}</div><div class="lbl">Hours</div></div>
    <div class="stat-box"><div class="val">${entries.length?(totalHours/entries.length).toFixed(1):'0'}</div><div class="lbl">Avg Hrs</div></div>`;
  const defs = [
    {id:'chartHours',fn:makeHoursChart},{id:'chartWind',fn:makeWindChart},
    {id:'chartFocus',fn:makeFocusChart},{id:'chartMains',fn:makeMainsChart},
    {id:'chartJibs',fn:makeJibsChart},{id:'chartKites',fn:makeKitesChart},
    {id:'chartRigging',fn:makeRiggingChart},{id:'chartBoard',fn:makeBoardChart},
  ];
  defs.forEach(({id,fn}) => { if (charts[id]) charts[id].destroy(); charts[id] = fn(id); });
}

function ctxTheme() {
  return {
    plugins: { legend: { labels: { color:'#7fa8c0', font:{family:'Barlow Condensed',size:13} } } },
    scales: {
      x: { ticks:{color:'#7fa8c0',font:{family:'Barlow',size:11}}, grid:{color:'rgba(0,180,216,0.1)'} },
      y: { ticks:{color:'#7fa8c0',font:{family:'Barlow',size:11}}, grid:{color:'rgba(0,180,216,0.1)'} },
    }
  };
}

function countField(f) {
  return entries.reduce((acc,e) => { const v=e[f]||'Unknown'; acc[v]=(acc[v]||0)+1; return acc; }, {});
}

function makeHoursChart(id) {
  const last10 = [...entries].reverse().slice(-10);
  return new Chart(document.getElementById(id), {
    type:'bar',
    data:{ labels:last10.map(e=>e.date?e.date.slice(5):''), datasets:[{data:last10.map(e=>parseFloat(e.hours)||0),backgroundColor:'rgba(0,180,216,0.6)',borderColor:'#00b4d8',borderWidth:1,borderRadius:4}] },
    options:{...ctxTheme(), plugins:{...ctxTheme().plugins,legend:{display:false}}}
  });
}

function makeWindChart(id) {
  const counts = countField('wind');
  const order = ['0-6kts','7-10kts','11-15kts','16-20kts','20-25kts','25+kts'];
  const labels = order.filter(k=>counts[k]);
  return new Chart(document.getElementById(id), {
    type:'doughnut',
    data:{labels, datasets:[{data:labels.map(l=>counts[l]||0),backgroundColor:['#023e8a','#0077b6','#0096c7','#00b4d8','#48cae4','#90e0ef'],borderColor:'#0a1628',borderWidth:2}]},
    options:{plugins:{legend:{labels:{color:'#7fa8c0',font:{family:'Barlow Condensed',size:13}}}}}
  });
}

function makeFocusChart(id) {
  const counts = countField('focus');
  return new Chart(document.getElementById(id), {
    type:'pie',
    data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts),backgroundColor:['#f4a261','#e76f51','#2a9d8f','#e9c46a'],borderColor:'#0a1628',borderWidth:2}]},
    options:{plugins:{legend:{labels:{color:'#7fa8c0',font:{family:'Barlow Condensed',size:13}}}}}
  });
}

function makeSailBar(id, field, color) {
  const counts = countField(field);
  delete counts['']; delete counts['Unknown'];
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  if (!sorted.length) {
    const el = document.getElementById(id);
    el.style.display='none';
    el.insertAdjacentHTML('afterend','<p style="color:var(--muted);font-size:0.85rem;padding:6px 0;">No data yet</p>');
    return {destroy:()=>{}};
  }
  return new Chart(document.getElementById(id), {
    type:'bar',
    data:{labels:sorted.map(s=>s[0]),datasets:[{data:sorted.map(s=>s[1]),backgroundColor:color,borderRadius:4}]},
    options:{...ctxTheme(),plugins:{...ctxTheme().plugins,legend:{display:false}},indexAxis:'y'}
  });
}

function makeMainsChart(id)  { return makeSailBar(id,'main','rgba(244,162,97,0.75)'); }
function makeJibsChart(id)   { return makeSailBar(id,'jib','rgba(72,202,228,0.75)'); }
function makeKitesChart(id)  { return makeSailBar(id,'kite','rgba(42,157,143,0.75)'); }
function makeBoardChart(id)  { return makeSailBar(id,'board','rgba(233,196,106,0.75)'); }

function makeRiggingChart(id) {
  const fields = ['mast','shrouds','luffwire','jibwire'];
  const labels = ['HD1','HD2','HD3','HD4','HD5','HD6','HD7','HD8','HD9','HD10','HD11','HD12','HD13','HD14','HD15'];
  const colors = ['rgba(0,180,216,0.8)','rgba(0,119,182,0.8)','rgba(244,162,97,0.8)','rgba(42,157,143,0.8)'];
  const names = ['Mast','Shrouds','Luff Wire','Jib Wire'];
  return new Chart(document.getElementById(id), {
    type:'bar',
    data:{labels,datasets:fields.map((f,i)=>({label:names[i],data:labels.map(l=>(countField(f)[l]||0)),backgroundColor:colors[i],borderRadius:3}))},
    options:{
      ...ctxTheme(),
      plugins:{legend:{labels:{color:'#7fa8c0',font:{family:'Barlow Condensed',size:12}}}},
      scales:{
        x:{ticks:{color:'#7fa8c0',font:{family:'Barlow',size:10}},grid:{color:'rgba(0,180,216,0.1)'}},
        y:{ticks:{color:'#7fa8c0',font:{family:'Barlow',size:11},stepSize:1},grid:{color:'rgba(0,180,216,0.1)'}},
      }
    }
  });
}

(async () => {
  await load();
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('f-boat').value = 'The Dame';
  updateBanner();
})();
</script>
</body>
</html>
